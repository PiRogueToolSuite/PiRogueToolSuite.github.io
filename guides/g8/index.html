<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=/main.4afba82c84ce5495177d6914104a204022e72fe906b28a0c7328e6153cd1975127496a1929b40f5f3aca1d452da8915340b3f1e5ada2ff5b4a6f879ebaa265e9.css integrity="sha512-SvuoLITOVJUXfWkUEEogQCLnL+kGsooMcyjmFTzRl1EnSWoZKbQPXzrKHUUtqJFTQLPx5a2i/1tKb4eeuqJl6Q==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Advanced guide - How to use PTS to intercept the TLS and cleartext network traffic of an app - PiRogue tool suite</title><meta name=description content="Objective # The objective of this guide is to provide a step-by-step procedure allowing you to intercept and decrypt the TLS traffic of an Android application using PiRogue capabilities.
Mobile application dynamic analysis # Mobile application dynamic analysis is a sophisticated approach to evaluating the behavior of mobile apps while they are actively running on a real device or an emulator. Unlike static analysis, which examines the app&amp;rsquo;s code without executing it, dynamic analysis observes the app&amp;rsquo;s actions and interactions in real-time, providing a deeper understanding of its runtime behavior and potential security vulnerabilities."><link rel=canonical href=/guides/g8/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Advanced guide - How to use PTS to intercept the TLS and cleartext network traffic of an app"><meta property="og:description" content="Objective # The objective of this guide is to provide a step-by-step procedure allowing you to intercept and decrypt the TLS traffic of an Android application using PiRogue capabilities.
Mobile application dynamic analysis # Mobile application dynamic analysis is a sophisticated approach to evaluating the behavior of mobile apps while they are actively running on a real device or an emulator. Unlike static analysis, which examines the app&rsquo;s code without executing it, dynamic analysis observes the app&rsquo;s actions and interactions in real-time, providing a deeper understanding of its runtime behavior and potential security vulnerabilities."><meta property="og:url" content="/guides/g8/"><meta property="og:site_name" content="PiRogue tool suite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@PiRogueTools"><meta name=twitter:creator content="@u039b"><meta name=twitter:title content="Advanced guide - How to use PTS to intercept the TLS and cleartext network traffic of an app"><meta name=twitter:description content><meta name=twitter:card content="summary"><meta name=twitter:image:alt content="Advanced guide - How to use PTS to intercept the TLS and cleartext network traffic of an app"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"/#/schema/organization/1","name":"PiRogue tool suite","url":"/","sameAs":["https://twitter.com/PiRogueTools","https://github.com/PiRogueToolSuite/"],"logo":{"@type":"ImageObject","@id":"/#/schema/image/1","url":"/android-chrome-512x512.png","width":512,"height":512,"caption":"PiRogue tool suite"},"image":{"@id":"/#/schema/image/1"}},{"@type":"WebSite","@id":"/#/schema/website/1","url":"/","name":"PiRogue tool suite","description":"PiRogue tool suite (PTS) is an open-source tool suite that provides a comprehensive mobile forensic and network traffic analysis platform targeting mobile devices both Android and iOS, internet of things devices (devices that are connected to the user mobile apps), and in general any device using wi-fi to connect to the Internet.","publisher":{"@id":"/#/schema/organization/1"}},{"@type":"WebPage","@id":"/guides/g8/","url":"/guides/g8/","name":"Advanced guide - How to use PTS to intercept the TLS and cleartext network traffic of an app","description":"","isPartOf":{"@id":"/#/schema/website/1"},"about":{"@id":"/#/schema/organization/1"},"datePublished":"0001-01-01T00:00:00CET","dateModified":"0001-01-01T00:00:00CET","breadcrumb":{"@id":"/guides/g8/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"/guides/g8/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["/guides/g8/"]}]},{"@type":"BreadcrumbList","@id":"/guides/g8/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"/","url":"/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@id":"/guidesg8/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"/guides/g8/#/schema/image/2","url":null,"contentUrl":null,"caption":"Advanced guide - How to use PTS to intercept the TLS and cleartext network traffic of an app"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=/site.webmanifest></head><body class="guides single"><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-xxl flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=/ aria-label="PiRogue tool suite">PiRogue tool suite</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-start border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=/>PiRogue tool suite</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1 active" href=/guides/>Guides</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/docs/prologue/introduction/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/blog/>Blog</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/contributors/>Contributors</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/about/>About</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=/contact/>Contact</a></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/PiRogueToolSuite><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://twitter.com/PiRogueTools><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg><small class="ms-2 d-md-none">Twitter</small></a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://discord.gg/qGX73GYNdp><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-message-square"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg><small class="ms-2 d-md-none">Discord</small></a></li></ul></div></div><button id=mode class="btn btn-link order-md-1" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button></nav></header><div class="wrap container-fluid" role=document><div class=content><div class="row justify-content-center flex-xl-nowrap"><nav class="docs-toc d-none d-xl-block col-xl-3" aria-label="Secondary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><ul><li><a href=#objective>Objective</a></li><li><a href=#mobile-application-dynamic-analysis>Mobile application dynamic analysis</a><ul><li><a href=#tls-traffic-decryption-techniques>TLS traffic decryption techniques</a></li></ul></li><li><a href=#requirements>Requirements</a></li><li><a href=#procedure>Procedure</a><ul><li><a href=#identify-and-install-the-application>Identify and install the application</a></li><li><a href=#instrument-and-intercept>Instrument and intercept</a></li><li><a href=#decrypt-the-traffic>Decrypt the traffic</a></li></ul></li><li><a href=#generated-files>Generated files</a></li></ul></li></ul></nav></div></nav><main class="docs-content col-lg-11 col-xl-9"><h1>Advanced guide - How to use PTS to intercept the TLS and cleartext network traffic of an app</h1><p class=lead></p><nav class=d-xl-none aria-label="Quaternary navigation"><div class=page-links><h3>On this page</h3><nav id=TableOfContents><ul><li><ul><li><a href=#objective>Objective</a></li><li><a href=#mobile-application-dynamic-analysis>Mobile application dynamic analysis</a><ul><li><a href=#tls-traffic-decryption-techniques>TLS traffic decryption techniques</a></li></ul></li><li><a href=#requirements>Requirements</a></li><li><a href=#procedure>Procedure</a><ul><li><a href=#identify-and-install-the-application>Identify and install the application</a></li><li><a href=#instrument-and-intercept>Instrument and intercept</a></li><li><a href=#decrypt-the-traffic>Decrypt the traffic</a></li></ul></li><li><a href=#generated-files>Generated files</a></li></ul></li></ul></nav></div></nav><h2 id=objective>Objective <a href=#objective class=anchor aria-hidden=true>#</a></h2><p>The objective of this guide is to provide a step-by-step procedure allowing you to intercept and decrypt the TLS traffic of an Android application using PiRogue capabilities.</p><h2 id=mobile-application-dynamic-analysis>Mobile application dynamic analysis <a href=#mobile-application-dynamic-analysis class=anchor aria-hidden=true>#</a></h2><p>Mobile application dynamic analysis is a sophisticated approach to evaluating the behavior of mobile apps while they are actively running on a real device or an emulator. Unlike static analysis, which examines the app&rsquo;s code without executing it, dynamic analysis observes the app&rsquo;s actions and interactions in real-time, providing a deeper understanding of its runtime behavior and potential security vulnerabilities.</p><p><strong>Dynamic analysis</strong> involves executing the app in a controlled environment and monitoring its interactions with the operating system, network resources, and other applications. This process reveals how the app handles user input, processes data, and communicates with external services. By observing these behaviors, security analysts can identify potential vulnerabilities, such as improper data handling, insecure network communications, or unauthorized access to sensitive resources.</p><p>The outcomes of mobile application dynamic analysis can provide valuable insights into the app&rsquo;s security posture and potential risks:</p><ul><li><p>Identifying hidden behaviors: Dynamic analysis can uncover hidden or obfuscated behaviors that may not be evident from static code inspection. This includes actions triggered by specific user inputs, interactions with external servers, or malicious code hidden within legitimate app functions.</p></li><li><p>Detecting runtime vulnerabilities: Dynamic analysis can expose vulnerabilities that manifest during runtime, such as buffer overflows, memory leaks, or improper input validation. These vulnerabilities may not be detectable through static analysis, as they only occur when the app is actively processing data or interacting with external systems.</p></li><li><p>Analyzing network communications: Dynamic analysis allows for monitoring of network traffic generated by the app, revealing potential data leaks, insecure communication protocols, or connections to suspicious servers. This can help identify unauthorized data transfers or potential backdoors for attackers.</p></li><li><p>Evaluating app resilience: Dynamic analysis can assess the app&rsquo;s resilience to unexpected inputs or abnormal conditions. This includes testing how the app handles malformed data, unexpected user actions, or attempts to exploit vulnerabilities.</p></li><li><p>Understanding app permissions: Dynamic analysis can reveal how the app utilizes permissions granted to it, such as access to contacts, location data, or device sensors. This can uncover excessive or unauthorized permission usage that could pose privacy risks.</p></li></ul><p>In summary, mobile application dynamic analysis provides a comprehensive assessment of an app&rsquo;s behavior and security posture, uncovering hidden vulnerabilities, analyzing runtime interactions, and evaluating overall resilience. This approach plays a crucial role in ensuring the security and privacy of mobile applications and protecting users from potential threats.</p><p>The PiRogue is designed to conduct mobile application dynamic analysis on real devices using tcpdump to capture the entire network traffic and using Frida to instrument the application to be analyzed.</p><p><strong>Mobile application dynamic instrumentation</strong> is a powerful technique for modifying and monitoring the behavior of mobile apps while they are actively running. It involves injecting custom code into the app&rsquo;s runtime environment, enabling real-time observation and manipulation of its functions, data flows, and interactions with the operating system.</p><p>Dynamic instrumentation provides a deeper understanding of an app&rsquo;s inner workings, allowing for various security and debugging tasks:</p><ul><li><p>Hooking functions: Intercept and modify the behavior of specific functions within the app, enabling the analysis of data passed to or from those functions.</p></li><li><p>Monitoring data flows: Track the movement of data within the app, revealing how it handles sensitive information, communicates with external services, or stores data locally.</p></li></ul><p><strong>Frida</strong> is a popular open-source dynamic instrumentation toolkit that facilitates these tasks. It provides a cross-platform framework for injecting custom JavaScript code into running apps on various platforms, including Android, iOS, and desktop operating systems. Frida&rsquo;s capabilities include:</p><ul><li><p>Intercepting function calls: Frida can intercept calls to specific functions within the app, allowing for modification of their behavior or analysis of their parameters and return values.</p></li><li><p>Monitoring memory access: Frida can monitor memory access patterns, revealing how the app allocates, reads, and modifies data in memory.</p></li><li><p>Manipulating app state: Frida can modify app variables, alter control flows, and inject events, enabling fine-grained control over the app&rsquo;s behavior.</p></li></ul><p>Frida&rsquo;s versatility makes it a valuable tool for security researchers, reverse engineers, and app developers who need to understand and manipulate the inner workings of mobile apps at runtime.</p><p>More precisely, PiRogue uses Frida to:</p><ul><li>Retrieve TLS encryption keys directly from the device’s memory allowing TLS traffic decryption afterwards.</li><li>Capture all AES and RSA cryptographic operations by retrieving initialization vectors, algorithms, ciphertext and cleartext allowing to decrypt encrypted payloads.</li><li>Save device’s identifiers and properties such as IMEI, advertising ID and carrier name allowing automatic data identification afterwards.</li><li>Trace all operations on socket allowing to identify the stack trace that carried out a specific network communication.</li></ul><p>To conduct the analysis of an application installed on the rooted Android device dedicated to dynamic analysis and the device is connected with both USB and Wi-Fi to the PiRogue, the command</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>$ pirogue-intercept-gated -o &lt;path to the output directory&gt;
</span></span></code></pre></div><p>will take care of starting the network traffic capture, the instrumentation of the application and the recording of the device’s screen.</p><p>Before starting the capture, the command will install the Frida server on the mobile device of the same version as the version of Frida that is installed on the PiRogue. Once installed, the command will start capturing the network traffic, recording the screen of the device and instrumenting any app or process that is spawned until the capture is stopped.</p><p>The Frida scripts used to instrument the application and the operating system can be reviewed <a href=https://github.com/PiRogueToolSuite/pirogue-cli/tree/debian-12/pirogue_cli/frida-scripts>on GitHub</a>.</p><p>It is possible to open the PCAP file with Wireshark and specify the key log file in <em>Settings > Protocols > TLS</em>. This way, Wireshark will automatically decrypt TLS traffic.</p><h3 id=tls-traffic-decryption-techniques>TLS traffic decryption techniques <a href=#tls-traffic-decryption-techniques class=anchor aria-hidden=true>#</a></h3><p>Decrypting TLS-encrypted network traffic of a mobile application requires specialized techniques to overcome the security measures employed by the app and the underlying operating system. Two primary techniques can be employed for this purpose:</p><p><strong>Man-in-the-Middle (MITM) attack</strong></p><figure class=text-center><img class="img-fluid lazyload blur-up d-block mx-auto" data-sizes=auto src=/guides/g8/img/mitm_huce5ae146eee97cb500c1e0dd42554ec6_19209_1800x0_resize_box_3.png data-srcset width=427 height=166><noscript><img class="img-fluid d-block mx-auto" sizes=100vw srcset src=/guides/g8/img/mitm.png width=427 height=166></noscript></figure><p>MITM attacks involve intercepting and modifying the communication between the mobile app and its intended server. This requires positioning a proxy or a custom certificate authority (CA) between the app and the server, effectively impersonating the server to the app and vice versa.</p><p>To establish the MITM attack, the device&rsquo;s trust store needs to be modified to accept the custom CA certificate. This can be achieved by installing a custom root certificate on the device or configuring the app to trust a specific proxy. Once the MITM proxy is in place, it can intercept the encrypted traffic, decrypt it using its own private key, and re-encrypt it before forwarding it to the intended server.</p><p><strong>Retrieving TLS Keys from device memory</strong></p><figure class=text-center><img class="img-fluid lazyload blur-up d-block mx-auto" data-sizes=auto src=/guides/g8/img/pirogue_huf8f5ea8882ae3d018b68f9f58d395b11_17338_1800x0_resize_box_3.png data-srcset width=450 height=155><noscript><img class="img-fluid d-block mx-auto" sizes=100vw srcset src=/guides/g8/img/pirogue.png width=450 height=155></noscript></figure><p>This technique involves extracting the TLS session keys directly from the device&rsquo;s memory while the app is actively communicating with the server. This requires root access or a jailbroken device to gain access to the memory space where the keys are stored.</p><p>Once root access is obtained, tools like Frida can be used to hook into the app&rsquo;s memory and extract the TLS session keys. These keys can then be used to decrypt the captured network traffic offline, revealing the plaintext communication between the app and the server.</p><p><strong>Certificate Pinning</strong> is a security measure that aims to prevent MITM attacks by embedding the server&rsquo;s certificate or its public key hash directly into the mobile app. This allows the app to verify the authenticity of the server&rsquo;s certificate during communication, ensuring that it is not being intercepted by a malicious proxy.</p><p>With certificate pinning in place, the app will only trust connections to the server if the presented certificate matches the embedded one. This makes it more difficult for attackers to successfully perform MITM attacks, as they would need to compromise the app itself or the device&rsquo;s operating system to bypass the pinning mechanism. Disabling certificate pinning requires root access or a jailbroken device to dynamically modify the behavior of the application.</p><p>Certificate pinning enhances the security of mobile app communications, but it also poses challenges for legitimate security analysis and penetration testing. In such cases, techniques like dynamic instrumentation or memory dumping may be required to bypass pinning and gain access to the encrypted traffic.</p><p>This Frida script used by the PiRogue aims to intercept and log TLS (Transport Layer Security) key material used by an Android application. It achieves this by hooking into the OpenSSL library and its associated functions responsible for creating and managing SSL contexts.</p><p>The script defines a function <code>log_ssl_keys()</code>, which serves as the main entry point for the keylogging process. It first attempts to hook into the standard <code>libssl.so</code> library, the default OpenSSL library used by most applications. It calls <code>_log_ssl_keys()</code> to attach a callback function to the <code>SSL_CTX_new</code> function, which is responsible for creating new SSL contexts.</p><p>The <code>_log_ssl_keys()</code> function defines a custom callback function <code>log_key()</code> that gets invoked whenever a new SSL context is created. This callback function retrieves the SSL key material from the context and logs it to the console and a file named <code>sslkeylog.txt</code>.</p><p>The script also handles the scenario where the application relies on Google&rsquo;s Conscrypt security provider, which uses a different OpenSSL library. It identifies the relevant Conscrypt libraries and hooks into their <code>SSL_CTX_new</code> functions using the same approach as with the standard <code>libssl.so</code>.</p><p>In addition, the script intercepts the dlopen function, which is responsible for loading dynamic libraries. This allows the script to hook into the Conscrypt libraries even if they are loaded after the script has started running.</p><h2 id=requirements>Requirements <a href=#requirements class=anchor aria-hidden=true>#</a></h2><p>To follow this recipe, you need:</p><ul><li>an up-to-date PiRogue</li><li>a rooted Android device</li></ul><h2 id=procedure>Procedure <a href=#procedure class=anchor aria-hidden=true>#</a></h2><p>PiRogue comes with a <code>pirogue-intercept-*</code> helpers to help you intercept encrypted TLS traffic from applications, even in presence of TLS certificate pinning.</p><p>These helpers are meant to:</p><ul><li>capture the network traffic</li><li>instrument a specific application or any launched application</li></ul><p>First, SSH onto your PiRogue. Attach your smartphone to the PiRogue through USB and make sure &ldquo;USB debugging&rdquo; is on and working.</p><p>Make sure to enable ADB <em>Transfer files</em> by clicking on the <em>Android System</em> notification.</p><center><video height=480 controls>
<source src=img/adb_config_out.mp4 type=video/mp4><source src=img/adb_config_out.webm type=video/webm>Your browser does not support the video tag.</video></center><p>Then check if the PiRogue <em>sees</em> your device by running the command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>adb devices
</span></span></code></pre></div><p>You should see your device listed. If not, be sure to use the right USB cable for your device. If the issue remains, check that you have the rights to interact with USB devices. To do so, run the command <code>groups</code> to list the groups you belong to and check if the group <code>plugdev</code> is listed. If not, execute the following command <code>sudo usermod -aG plugdev $LOGNAME</code> and reboot.</p><h3 id=identify-and-install-the-application>Identify and install the application <a href=#identify-and-install-the-application class=anchor aria-hidden=true>#</a></h3><p>Android applications are identified by their <em>package name</em>. As an example, the French weather forecast application is <code>fr.meteo</code>. You can get the package name either from Google Play URL or from any tool analyzing Android apps such as <a href=https://beta.pithus.org>Pithus</a>, <a href=https://www.virustotal.com/gui/home/upload>Virus Total</a>, etc. In our example, the Google Play URL looks like <code>https://play.google.com/store/apps/details?id=fr.meteo</code>, the package name of the application is specified after <code>id=</code>.</p><p>Once you have identified the application you want to analyze, you have to download and install it on your target device. If you need to download the application from Google Play, we recommend to use <a href=https://github.com/EFForg/apkeep><code>apkeep</code></a> (not installed by default on PiRogue).</p><p>Finally, to install the application, run the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>adb install &lt;APK file&gt;
</span></span></code></pre></div><p>If your application contains multiple APKs (like in XAPK), use the command <code>adb install-multiple &lt;list all apks></code>.</p><p>Don&rsquo;t launch the application.</p><h3 id=instrument-and-intercept>Instrument and intercept <a href=#instrument-and-intercept class=anchor aria-hidden=true>#</a></h3><p>Once the application to be analyzed is installed on your Android device, connect your device to the PiRogue Wi-Fi network and run the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo pirogue-intercept-gated -o &lt;path to the output directory&gt;
</span></span></code></pre></div><p>Adapt the command according to your output directory of choice. Once started and showing <code>Waiting for data</code>, manually launch the application you want to analyze.</p><figure class=text-center><img class="img-fluid lazyload blur-up d-block mx-auto shadow" data-sizes=auto src=/guides/g8/img/launch_hub582c82064322eb2bcb94175190a7bf6_71528_1800x0_resize_box_3.png data-srcset width=1360 height=312 alt="Command capturing TLS traffic"><noscript><img class="img-fluid d-block mx-auto shadow" sizes=100vw srcset src=/guides/g8/img/launch.png width=1360 height=312 alt="Command capturing TLS traffic"></noscript></figure><p>Now, interact with the application freely. When you are done interacting with the app, hit <code>Ctrl</code>+<code>C</code> on your keyboard to stop interception.</p><div class="alert alert-doks d-flex" role=alert><div class="flex-shrink-1 alert-icon">⚠️</div><div class=w-100>Make sure that the application you want to be analyzed is not running in background. You can, for example, force stop it in <em>Settings > Apps</em>, select the application and click on <em>Stop</em>.</div></div><h3 id=decrypt-the-traffic>Decrypt the traffic <a href=#decrypt-the-traffic class=anchor aria-hidden=true>#</a></h3><p>If we run the previous command with <code>sudo</code>, we have to fix the permissions of generated files by running:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>chown -R pi:pi &lt;path to the output directory&gt;
</span></span></code></pre></div><p>Then enter the output directory with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>cd</span> &lt;path to the output directory&gt;
</span></span></code></pre></div><figure class=text-center><img class="img-fluid lazyload blur-up d-block mx-auto shadow" data-sizes=auto src=/guides/g8/img/permissions_hu56c44dc406775d9a7b7a274318721e55_48607_1800x0_resize_box_3.png data-srcset width=821 height=243 alt="Command fixing file permissions"><noscript><img class="img-fluid d-block mx-auto shadow" sizes=100vw srcset src=/guides/g8/img/permissions.png width=821 height=243 alt="Command fixing file permissions"></noscript></figure><p>Next, we generate a PCAPNG file containing both the TLS keys and the captured traffic:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>editcap --inject-secrets tls,sslkeylog.txt traffic.pcap decrypted.pcapng
</span></span></code></pre></div><p>Next, we export the decrypted traffic in JSON:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>tshark -2 -T ek --enable-protocol communityid -Ndmn -r decrypted.pcapng &gt; traffic.json
</span></span></code></pre></div><figure class=text-center><img class="img-fluid lazyload blur-up d-block mx-auto shadow" data-sizes=auto src=/guides/g8/img/decrypt_hu68aba39f36441a6927d28c54fa344322_79002_1800x0_resize_box_3.png data-srcset width=1687 height=306 alt="Command decrypting TLS traffic"><noscript><img class="img-fluid d-block mx-auto shadow" sizes=100vw srcset src=/guides/g8/img/decrypt.png width=1687 height=306 alt="Command decrypting TLS traffic"></noscript></figure><p>Finally, to view the decrypted traffic, run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>pirogue-view-tls -i traffic.json -t socket_trace.json
</span></span></code></pre></div><figure class=text-center><img class="img-fluid lazyload blur-up d-block mx-auto shadow" data-sizes=auto src=/guides/g8/img/view+_hu918e11f098e4cee88f9b2fc71d97ba7c_131543_1800x0_resize_box_3.png data-srcset width=1412 height=933 alt="Command displaying TLS traffic"><noscript><img class="img-fluid d-block mx-auto shadow" sizes=100vw srcset src=/guides/g8/img/view+.png width=1412 height=933 alt="Command displaying TLS traffic"></noscript></figure><div class="alert alert-doks d-flex" role=alert><div class="flex-shrink-1 alert-icon">⚠️</div><div class=w-100>The display of the stack trace has been added to <code>pirogue-cli</code> in version <code>1.0.5</code>. Be sure to upgrade your PiRogue.</div></div><p>If you face any issue, <a href=https://discord.gg/qGX73GYNdp>join the Discord channel</a> to get help.</p><h2 id=generated-files>Generated files <a href=#generated-files class=anchor aria-hidden=true>#</a></h2><p>The commands <code>pirogue-intercept-single</code> and <code>pirogue-intercept-gated</code> generate the following files:</p><ul><li><code>aes_info.json</code> contains all AES and RSA encryption/decryption operation with both cleartext and cyphertext</li><li><code>device.json</code> contains various information about the device such as IMEI, Android version</li><li><code>experiment.json</code> contains timing information such as the start and end date of the experiment</li><li><code>screen.mp4</code> contains the video recording of the device&rsquo;s screen</li><li><code>socket_trace.json</code> contains the stack trace of all operations on sockets (open, close, read, write&mldr;)</li><li><code>sslkeylog.txt</code> contains the TLS encryption keys in the <a href=https://firefox-source-docs.mozilla.org/security/nss/legacy/key_log_format/index.html>NSS key log format</a></li><li><code>traffic.pcap</code> contains the entire network traffic captured during the experiment</li><li><code>ad_ids.txt</code> contains all Android advertising IDs issued during the experiment</li></ul><p><strong>NB</strong>: you can open the PCAP file with Wireshark and specify the key log file in <em>Settings > Protocols > TLS</em>. This way, Wireshark will automatically decrypt TLS traffic.</p><div class="page-footer-meta d-flex flex-column flex-md-row justify-content-between"></div></main></div></div></div><footer class="footer text-muted"><div class=container-xxl><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item></li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline></ul></div></div></div></footer><script defer data-domain=pts-project.org src=https://plausible.io/js/script.js></script>
<script src=/js/bootstrap.min.8a4a3d8b214130d694b91942f330a0ec0c040217d0a2d422dd41c29176f49518f95cfb7846634f3b82e7fe358e0ba64b9b80263c759b07e85b7cc479c8875628.js integrity="sha512-iko9iyFBMNaUuRlC8zCg7AwEAhfQotQi3UHCkXb0lRj5XPt4RmNPO4Ln/jWOC6ZLm4AmPHWbB+hbfMR5yIdWKA==" crossorigin=anonymous defer></script>
<script src=/main.min.032f7f61db03165191ebf51143f7844840a639c8306d581472572d13d43b8a8d7bfa35f684782ab0505a3aa4bbf10089cc9501571550beea562134f6070752cb.js integrity="sha512-Ay9/YdsDFlGR6/URQ/eESECmOcgwbVgUclctE9Q7io17+jX2hHgqsFBaOqS78QCJzJUBVxVQvupWITT2BwdSyw==" crossorigin=anonymous defer></script></body></html>